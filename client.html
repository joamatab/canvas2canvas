<!doctype html>

<div class="viewer-panel">
  <div class="viewer-panel-sub">
    <div class="viewer-frame-cell">
      <div class="viewer-frame" id="layout-view">
        <canvas id="layout_canvas"></canvas>
      </div>
    </div>
    <div class="viewer-layers-cell">
      <div class="viewer-layers" id="layers">
        here are the layers<br>
        here are the layers<br>
        here are the layers<br>
        here are the layers<br>
        here are the layers<br>
        here are the layers<br>
        here are the layers<br>
        here are the layers<br>
        here are the layers<br>
        here are the layers<br>
        here are the layers<br>
        here are the layers<br>
        here are the layers<br>
        here are the layers<br>
        here are the layers<br>
        here are the layers<br>
        here are the layers<br>
        here are the layers<br>
        here are the layers<br>
        here are the layers<br>
        here are the layers<br>
        here are the layers<br>
        here are the layers<br>
        here are the layers<br>
        here are the layers<br>
        here are the layers<br>
        here are the layers<br>
        here are the layers<br>
        here are the layers<br>
        here are the layers<br>
        here are the layers<br>
        here are the layers<br>
        here are the layers<br>
        here are the layers<br>
        here are the layers<br>
        here are the layers<br>
        here are the layers<br>
        here are the layers<br>
        here are the layers<br>
        here are the layers<br>
      </div>
    </div>
  </div>
</div>

<div id="message">
</div>

<style>

#layout_canvas {
  width: 100%;
  height: 100%;
}

.viewer-panel {
  overflow: auto;
  display: table;
  border-spacing: 0.5rem;
  padding: 0;
}

.viewer-panel-sub {
  display: table-row;
}

.viewer-frame-cell {
  display: table-cell;
  vertical-align: top;
  border: 1px solid #000000;
  overflow: hidden;
}

.viewer-frame {
  width: 800px;
  height: 500px;
  resize: both;
  overflow: hidden;
  padding: 10px;
}

.viewer-layers-cell {
  display: table-cell;
  vertical-align: top;
  border: 1px solid #000000;
}

.viewer-layers {
  min-width: 20%;
  white-space: nowrap;
  overflow-y: scroll;
  padding: 0.5rem;
  height: 500px;
  padding: 10px;
}

</style>

<script>

let url = 'ws://localhost:8765/ws';

var canvas = document.getElementById("layout_canvas");
var context = canvas.getContext("2d");

var message = document.getElementById("message");

let socket = new WebSocket(url);
socket.binaryType = "blob";
var initialized = false;

socket.onopen = function(evt) {
  var ev = { msg: "initialize", width: canvas.width, height: canvas.height };
  socket.send(JSON.stringify(ev));
}

socket.onmessage = function(evt) {
  let data = evt.data;
  if (typeof(data) === "string") {
    //  incoming messages are JSON objects
    js = JSON.parse(data);
    if (js.msg == "initialized") {
      initialized = true;
    } else if (js.msg == "loaded") {
      message.textContent = data;
    }
  } else if (initialized) {
    //  incoming blob messages are paint events
    createImageBitmap(data).then(function(image) {
      context.drawImage(image, 0, 0)
    });
  }
};

socket.onclose = evt => console.log(`Closed ${evt.code}`);

function mouseEventToJSON(canvas, type, evt) {
  var rect = canvas.getBoundingClientRect();
  var x = evt.clientX - rect.left;
  var y = evt.clientY - rect.top;
  var keys = 0;
  if (evt.shiftKey) {
    keys += 1;
  }
  if (evt.ctrlKey) {
    keys += 2;
  }
  if (evt.altKey) {
    keys += 4;
  }
  return { msg: type, x: x, y: y, b: evt.buttons, k: keys };
}

function sendMouseEvent(canvas, type, evt) {
  if (socket.readyState == 1 /*OPEN*/) {
    var ev = mouseEventToJSON(canvas, type, evt);
    socket.send(JSON.stringify(ev));
  }
}

function sendWheelEvent(canvas, type, evt) {
  if (socket.readyState == 1 /*OPEN*/) {
    var ev = mouseEventToJSON(canvas, type, evt);
    ev.dx = evt.deltaX;
    ev.dy = evt.deltaY;
    ev.dm = evt.deltaMode;
    socket.send(JSON.stringify(ev));
  }
}

//  HTML5 does not have a resize event, so we need to poll

var lastCanvasWidth = 0;
var lastCanvasHeight = 0;

setInterval(function() {

  var view = document.getElementById('layout-view');
  var w = view.clientWidth;
  var h = view.clientHeight;

  if (lastCanvasWidth !== w || lastCanvasHeight !== h) {

    //  this avoids flicker:

    var tempCanvas = document.createElement('canvas');
    tempCanvas.width = canvas.width;
    tempCanvas.height = canvas.height;
    var tempContext = tempCanvas.getContext("2d");
    tempContext.drawImage(context.canvas, 0, 0);

    lastCanvasWidth = w;
    lastCanvasHeight = h;
    canvas.width = canvas.clientWidth;
    canvas.height = canvas.clientHeight;

    context.drawImage(tempContext.canvas, 0, 0);

    socket.send(JSON.stringify({ msg: "resize", width: canvas.width, height: canvas.height }));

    //  resizes the layer list:

    let layers = document.getElementById("layers");

    var padding = 10; //  padding in pixels
    layers.style.height = (h - 2 * padding) + "px";

  }

}, 10)

canvas.addEventListener('contextmenu', function(evt) {
  evt.preventDefault();
});

canvas.addEventListener('mousemove', function (evt) {
  sendMouseEvent(canvas, "mouse_move", evt);
  evt.preventDefault();
}, false);

canvas.addEventListener('click', function (evt) {
  sendMouseEvent(canvas, "mouse_click", evt);
  evt.preventDefault();
}, false);

canvas.addEventListener('dblclick', function (evt) {
  sendMouseEvent(canvas, "mouse_dblclick", evt);
  evt.preventDefault();
}, false);

canvas.addEventListener('mousedown', function (evt) {
  sendMouseEvent(canvas, "mouse_pressed", evt);
  evt.preventDefault();
}, false);

canvas.addEventListener('mouseup', function (evt) {
  sendMouseEvent(canvas, "mouse_released", evt);
  evt.preventDefault();
}, false);

canvas.addEventListener('mouseenter', function (evt) {
  sendMouseEvent(canvas, "mouse_enter", evt);
  evt.preventDefault();
}, false);

canvas.addEventListener('mouseout', function (evt) {
  sendMouseEvent(canvas, "mouse_leave", evt);
  evt.preventDefault();
}, false);

canvas.addEventListener('wheel', function (evt) {
  sendWheelEvent(canvas, "wheel", evt);
  evt.preventDefault();
}, false);

</script>
